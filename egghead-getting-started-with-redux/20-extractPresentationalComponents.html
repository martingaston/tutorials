<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Redux: Todo List Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.1/redux.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.7.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.7.0/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      .todo-completed {
        text-decoration: line-through;
        color: grey;
      }
      .current-filter {
        font-weight: 700;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { combineReducers, createStore } = Redux;
      const { Component } = React;

      const visibilityFilter = (state = "SHOW_ALL", action) => {
        switch (action.type) {
          case "SET_VISIBILITY_FILTER":
            return action.filter;
          default:
            return state;
        }
      };

      const todo = (state, action) => {
        switch (action.type) {
          case "ADD_TODO":
            return {
              id: action.id,
              text: action.text,
              completed: false
            };
          case "TOGGLE_TODO":
            if (state.id === action.id) {
              return {
                ...state,
                completed: !state.completed
              };
            } else {
              return state;
            }
          default:
            return state;
        }
      };

      const getVisibileTodos = (todos, filter) => {
        switch (filter) {
          case "SHOW_ALL":
            return todos;
          case "SHOW_COMPLETED":
            return todos.filter(t => t.completed);
          case "SHOW_ACTIVE":
            return todos.filter(t => !t.completed);
          default:
            return todos;
        }
      };

      const todos = (state = [], action) => {
        switch (action.type) {
          case "ADD_TODO":
            return [...state, todo(undefined, action)];
          case "TOGGLE_TODO":
            return state.map(t => todo(t, action));
          default:
            return state;
        }
      };

      const todoApp = combineReducers({ todos, visibilityFilter });
      const store = createStore(todoApp);
      let nextTodoId = 0;

      const Todo = ({ onClick, todo, completed, text }) => (
        <li className={completed ? "todo-completed" : ""} onClick={onClick}>
          {text}
        </li>
      );

      const TodoList = ({ todos, onTodoClick }) => (
        <ul>
          {todos.map(todo => (
            <Todo
              key={todo.id}
              {...todo}
              onClick={() => onTodoClick(todo.id)}
            />
          ))}
        </ul>
      );

      class TodoApp extends Component {
        constructor(props) {
          super(props);
          this.state = {
            todoInput: ""
          };
          this.handleChange = this.handleChange.bind(this);
          this.handleKeyPress = this.handleKeyPress.bind(this);
          this.handleSubmit = this.handleSubmit.bind(this);
        }

        handleSubmit = e => {
          store.dispatch({
            type: "ADD_TODO",
            text: this.state.todoInput,
            id: nextTodoId++
          });
          this.setState({ todoInput: "" });
        };

        handleChange = e => {
          this.setState({ todoInput: e.target.value });
        };

        handleKeyPress = e => {
          if (e.key === "Enter") {
            this.handleSubmit();
          }
        };

        render() {
          const { todos, visibilityFilter } = this.props;
          const visibleTodos = getVisibileTodos(todos, visibilityFilter);

          const FilterLink = ({ filter, currentFilter, children }) => {
            if (filter === currentFilter)
              return <span className="current-filter">{children}</span>;

            return (
              <a
                href="#"
                onClick={e => {
                  e.preventDefault();
                  store.dispatch({
                    type: "SET_VISIBILITY_FILTER",
                    filter
                  });
                }}
              >
                {children}
              </a>
            );
          };

          return (
            <div>
              <input
                value={this.state.todoInput}
                onChange={this.handleChange}
                onKeyPress={this.handleKeyPress}
              />
              <button onClick={this.handleSubmit}>Add Todo</button>
              <TodoList
                todos={visibleTodos}
                onTodoClick={id => store.dispatch({ type: "TOGGLE_TODO", id })}
              />
              <p>
                Show:{" "}
                <FilterLink filter="SHOW_ALL" currentFilter={visibilityFilter}>
                  All
                </FilterLink>
                ,{" "}
                <FilterLink
                  filter="SHOW_COMPLETED"
                  currentFilter={visibilityFilter}
                >
                  Completed
                </FilterLink>
                ,{" "}
                <FilterLink
                  filter="SHOW_ACTIVE"
                  currentFilter={visibilityFilter}
                >
                  Active
                </FilterLink>
              </p>
            </div>
          );
        }
      }

      const render = () => {
        ReactDOM.render(
          <TodoApp {...store.getState()} />,
          document.getElementById("root")
        );
      };

      store.subscribe(render);
      render();
    </script>
  </body>
</html>
